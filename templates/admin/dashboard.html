<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Panel de Admin</a>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-light">Cerrar Sesión</a>
        </div>
    </nav>

    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="card mb-4">
            <div class="card-header"><h3>Crear Nueva Rifa</h3></div>
            <div class="card-body">
                <form action="{{ url_for('new_raffle') }}" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="title" class="form-label">Título de la Rifa</label>
                        <input type="text" name="title" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="images" class="form-label">Imágenes de la Rifa (hasta 4)</label>
                        <input type="file" name="images" class="form-control" multiple accept="image/*">
                    </div>
                    <div class="mb-3">
                        <label for="ticket_count" class="form-label">Cantidad de Boletos</label>
                        <select name="ticket_count" class="form-select">
                            <option value="100">100 Boletos (00-99)</option>
                            <option value="1000">1000 Boletos (000-999)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Crear Rifa</button>
                </form>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header"><h3>Gestionar Rifas</h3></div>
            <div class="card-body">
                <ul class="list-group">
                    {% for rifa in rifas %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ rifa.title }}</strong>
                                {% if rifa.is_active %}
                                    <span class="badge bg-success">Activa</span>
                                {% endif %}
                                <small class="d-block">Bloquear duplicados por Teléfono: 
                                    <a href="{{ url_for('toggle_duplicates', raffle_id=rifa.id) }}" class="badge {{ 'bg-info' if rifa.get('prevent_duplicates') else 'bg-warning text-dark' }}">
                                        {{ 'Sí' if rifa.get('prevent_duplicates') else 'No' }}
                                    </a>
                                </small>
                            </div>
                            <div>
                                {% if not rifa.is_active %}
                                    <a href="{{ url_for('activate_raffle', raffle_id=rifa.id) }}" class="btn btn-sm btn-success">Activar</a>
                                {% endif %}
                                <a href="{{ url_for('edit_raffle', raffle_id=rifa.id) }}" class="btn btn-sm btn-warning">Editar</a>
                                <a href="{{ url_for('delete_raffle', raffle_id=rifa.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('¿Estás seguro?')">Eliminar</a>
                            </div>
                        </li>
                    {% else %}
                        <li class="list-group-item">No hay rifas creadas.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        {% if active_raffle %}
        <div class="card mb-4">
            <div class="card-header"><h3>Control de Pagos: {{ active_raffle.title }}</h3></div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-striped">
                    <thead>
                        <tr><th>Boleto</th><th>Teléfono</th><th>Pagado</th><th>Acción</th></tr>
                    </thead>
                    <tbody>
                        {% for ticket in active_raffle_tickets %}
                        <tr>
                            <td>{{ ticket.number }}</td>
                            <td>{{ ticket.get('phone', 'N/A') }}</td>
                            <td>
                                <a href="{{ url_for('update_payment_status', raffle_id=active_raffle.id, ticket_number=ticket.number) }}" class="btn btn-sm {{ 'btn-success' if ticket.get('paid') == 'Sí' else 'btn-danger' }}">
                                    {{ ticket.get('paid', 'No') }}
                                </a>
                            </td>
                            <td>
                                <a href="{{ url_for('release_ticket', raffle_id=active_raffle.id, ticket_number=ticket.number) }}" class="btn btn-sm btn-warning" onclick="return confirm('¿Liberar este boleto?')">Liberar</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header"><h3>Configuración General del Sitio</h3></div>
            <div class="card-body">
                <form action="{{ url_for('update_settings') }}" method="post" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Logo Actual</label>
                                <div><img src="{{ url_for('uploaded_file', filename=settings.logo_image) if settings.logo_image else 'https://via.placeholder.com/100' }}" style="max-width: 100px; border-radius: 50%;"></div>
                                </div>
                            <div class="mb-3"><label for="logo_image" class="form-label">Subir Nuevo Logo</label><input type="file" name="logo_image" class="form-control" accept="image/*"></div>
                            <div class="mb-3"><label for="logo_size" class="form-label">Tamaño del Logo (en px)</label><input type="range" name="logo_size" class="form-range" min="40" max="150" value="{{ settings.logo_size }}"></div>
                            <hr>
                            <div class="mb-3"><label for="main_title" class="form-label">Título Principal del Premio</label><input type="text" name="main_title" class="form-control" value="{{ settings.main_title }}"></div>
                            <div class="mb-3"><label for="raffle_date" class="form-label">Texto de la Fecha de la Rifa</label><input type="text" name="raffle_date" class="form-control" value="{{ settings.raffle_date }}"></div>
                            <div class="mb-3"><label for="ticket_price_info" class="form-label">Información de Precios de Boletos</label><textarea name="ticket_price_info" class="form-control" rows="3">{{ settings.ticket_price_info }}</textarea></div>
                            <hr>
                            <div class="mb-3"><label for="tiktok_link" class="form-label">Enlace de TikTok</label><input type="url" name="tiktok_link" class="form-control" value="{{ settings.tiktok_link }}"></div>
                            <div class="mb-3"><label for="instagram_link" class="form-label">Enlace de Instagram</label><input type="url" name="instagram_link" class="form-control" value="{{ settings.instagram_link }}"></div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3"><label for="whatsapp_number" class="form-label">Tu Número de WhatsApp (ej: 521XXXXXXXXXX)</label><input type="text" name="whatsapp_number" class="form-control" value="{{ settings.whatsapp_number }}"></div>
                            <hr>
                            <div class="mb-3"><label for="main_color" class="form-label">Color Principal</label><input type="color" name="main_color" class="form-control form-control-color" value="{{ settings.main_color }}"></div>
                            <div class="mb-3"><label for="background_color" class="form-label">Color de Fondo</label><input type="color" name="background_color" class="form-control form-control-color" value="{{ settings.background_color }}"></div>
                            <div class="mb-3"><label for="text_color" class="form-label">Color del Texto</label><input type="color" name="text_color" class="form-control form-control-color" value="{{ settings.text_color }}"></div>
                            <hr>
                            <div class="mb-3"><label for="contact_info" class="form-label">Contenido de la Página de Contacto</label><textarea name="contact_info" class="form-control" rows="5">{{ settings.contact_info }}</textarea></div>
                            <div class="mb-3"><label for="payment_methods_info" class="form-label">Contenido de Métodos de Pago</label><textarea name="payment_methods_info" class="form-control" rows="5">{{ settings.payment_methods_info }}</textarea></div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3">Guardar Configuración</button>
                </form>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>